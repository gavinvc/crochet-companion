<section class="parser-hero">
  <div class="parser-lede">
    <p class="eyebrow">Pattern Parser</p>
    <h1>Turn any crochet pattern into step-by-step rows.</h1>
    <p class="lede">
      Paste raw text or point us at a URL. We will normalize the pattern into tidy, numbered rows so you can stitch at your own pace.
    </p>
    <ul class="hero-highlights">
      <li>Row-by-row navigation with stitched terms called out</li>
      <li>Works with plain text or web pages today</li>
      <li>Future: tap stitches to open technique tutorials</li>
    </ul>
  </div>

  <div class="parser-panel">
    <form [formGroup]="form" (ngSubmit)="submit()" class="parser-form">
      <header>
        <p class="eyebrow">Input</p>
        <div class="input-switch">
          <label>
            <input type="radio" value="text" formControlName="inputType" />
            Paste text
          </label>
          <label title="Fetch a public pattern page"> 
            <input type="radio" value="url" formControlName="inputType" />
            Fetch from URL
          </label>
          <label title="Upload a PDF pattern">
            <input type="radio" value="pdf" formControlName="inputType" />
            Upload PDF
          </label>
        </div>
      </header>

      <label class="field">
        <span>Pattern title (optional)</span>
        <input formControlName="title" placeholder="e.g., Cozy Moss Stitch Throw" />
      </label>

      <ng-container [ngSwitch]="form.controls.inputType.value">
        <label class="field" *ngSwitchCase="'text'">
          <span>Pattern text</span>
          <textarea
            formControlName="content"
            rows="8"
            placeholder="Paste a few rows or the full pattern text"
          ></textarea>
        </label>

        <ng-container *ngSwitchCase="'url'" [ngTemplateOutlet]="urlField"></ng-container>
        <ng-container *ngSwitchCase="'pdf'" [ngTemplateOutlet]="pdfField"></ng-container>
        <ng-container *ngSwitchDefault [ngTemplateOutlet]="urlField"></ng-container>
      </ng-container>

      <ng-template #urlField>
        <label class="field">
          <span>Pattern URL</span>
          <input formControlName="content" type="url" placeholder="https://designer-site.com/pattern" />
          <small class="field-hint">Public pages only; best results on simple text-based articles.</small>
        </label>
      </ng-template>

      <ng-template #pdfField>
        <label class="field">
          <span>PDF file</span>
          <input type="file" accept="application/pdf" (change)="onFileSelected($event)" />
          <small class="field-hint">We extract text from the PDF before parsing; scanned images are not supported.</small>
        </label>
      </ng-template>

      <div class="form-actions">
        <button type="submit" [disabled]="isLoading()">{{ isLoading() ? 'Parsing… (can take ~40s)' : 'Parse pattern' }}</button>
        <p *ngIf="isLoading()" class="loading-hint">Working on it… larger patterns can take a bit.</p>
        <p *ngIf="error()" class="error">{{ error() }}</p>
      </div>
    </form>
  </div>
</section>

<section #resultsSection id="results-section" class="parser-results" *ngIf="isLoading() || hasResult(); else emptyState">
  <div class="deployment-warning">
    <p class="eyebrow">Heads up</p>
    <p class="warning-text">Local LLM is required. Vercel dev/staging won’t return parser results until pointed at your self-hosted model.</p>
  </div>

  <div *ngIf="isLoading()" class="loading-panel">
    <p class="eyebrow">Parsing pattern</p>
    <p class="lede">Cozying up your rows… this can take a bit for longer patterns.</p>
    <div class="loading-shimmer"></div>
  </div>

  <div class="row-viewer" *ngIf="!isLoading() && activeRow() as row">
    <div class="row-list">
      <button
        type="button"
        *ngFor="let item of rows(); let i = index"
        (click)="selectRow(i)"
        [class.active]="i === activeRowIndex()"
      >
        <span>Row {{ item.rowNumber }}</span>
        <p>{{ item.instruction }}</p>
      </button>
    </div>

    <div class="row-detail">
      <div class="row-meta">
        <p class="eyebrow">Row {{ row.rowNumber }}</p>
        <div class="chips" *ngIf="row.stitches?.length">
          <span *ngFor="let stitch of row.stitches">{{ stitch }}</span>
        </div>
      </div>
      <p class="instruction">{{ row.instruction }}</p>
      <p *ngIf="row.notes" class="notes">{{ row.notes }}</p>

      <div class="row-nav">
        <button type="button" (click)="prevRow()" [disabled]="activeRowIndex() === 0">Previous row</button>
        <button type="button" (click)="nextRow()" [disabled]="activeRowIndex() >= rows().length - 1">
          Next row
        </button>
      </div>

      <div class="progress-actions">
        <p class="eyebrow">Maker space</p>
        <p class="progress-note">Row {{ (activeRowIndex() + 1) }} of {{ rows().length }}</p>
        <div class="buttons">
          <button type="button" (click)="saveProgress()" [disabled]="isSavingProgress() || !auth.isLoggedIn()">
            {{ isSavingProgress() ? 'Saving…' : savedProgress() ? 'Update progress' : 'Save progress' }}
          </button>
          <button
            type="button"
            class="ghost"
            (click)="markComplete()"
            [disabled]="isSavingProgress() || activeRowIndex() < rows().length - 1"
          >
            Mark completed
          </button>
        </div>
        <p *ngIf="!auth.isLoggedIn()" class="muted">Sign in to save and resume progress.</p>
        <p *ngIf="progressNotice()" class="success">{{ progressNotice() }}</p>
        <p *ngIf="progressError()" class="error">{{ progressError() }}</p>
      </div>
    </div>
  </div>
</section>

<ng-template #emptyState>
  <section class="empty-state">
    <p class="eyebrow">Pattern Parser</p>
    <h2>Paste text or a URL to see rows appear here.</h2>
    <p>We will break your pattern into numbered steps with stitch names highlighted.</p>
  </section>
</ng-template>

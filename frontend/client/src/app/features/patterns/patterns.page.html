<div class="patterns-page">
  <section class="patterns-hero">
    <div class="patterns-hero__copy">
      <p class="eyebrow">Pattern sharing</p>
      <h1>Find patterns to follow, save, and open row-by-row.</h1>
      <p class="lede">
        Browse shared patterns with images and numbered rows. Jump into a guided view, follow what you like, and keep everything in one place.
      </p>
      <div class="hero-actions">
        <button type="button" class="cta primary" (click)="scrollToPatterns()">Find patterns</button>
        <button type="button" class="cta outline" (click)="openShareModal()">Share a pattern</button>
      </div>
    </div>
  </section>

  <section class="maker-section" *ngIf="auth.isLoggedIn()">
    <header class="section-header">
      <div>
        <p class="eyebrow">Maker space</p>
        <h2>Your patterns</h2>
        <p class="lede muted">Quick access to what you published.</p>
      </div>
      <button type="button" class="cta ghost" (click)="openShareModal()">Share a pattern</button>
    </header>

    <div class="maker-grid" *ngIf="myPatterns().length; else emptyMine">
      <article class="maker-card" *ngFor="let pattern of myPatterns()">
        <div class="maker-card__head">
          <h3>{{ pattern.title }}</h3>
          <span class="pill">{{ rowsPreview(pattern) }}</span>
        </div>
        <p class="maker-card__meta">{{ pattern.followerCount || 0 }} followers</p>
        <div class="maker-card__actions">
          <button type="button" (click)="openPattern(pattern)">Open</button>
          <button type="button" class="ghost" (click)="toggleFollow(pattern)">
            {{ pattern.isFollowing ? 'Unfollow' : 'Follow' }}
          </button>
          <button type="button" class="ghost danger" *ngIf="pattern.isOwner" (click)="deletePattern(pattern)">Delete</button>
        </div>
      </article>
    </div>
    <ng-template #emptyMine>
      <p class="empty">You have not published any patterns yet.</p>
    </ng-template>
  </section>

  <section class="maker-section" *ngIf="auth.isLoggedIn()">
    <header class="section-header">
      <div>
        <p class="eyebrow">Maker space</p>
        <h2>Followed patterns</h2>
        <p class="lede muted">Stay close to what inspires you.</p>
      </div>
    </header>

    <div class="maker-grid" *ngIf="followedPatterns().length; else emptyFollowing">
      <article class="maker-card" *ngFor="let pattern of followedPatterns()">
        <div class="maker-card__head">
          <h3>{{ pattern.title }}</h3>
          <span class="pill">{{ rowsPreview(pattern) }}</span>
        </div>
        <p class="maker-card__meta">{{ pattern.followerCount || 0 }} followers</p>
        <div class="maker-card__actions">
          <button type="button" (click)="openPattern(pattern)">Open</button>
          <button type="button" class="ghost" (click)="toggleFollow(pattern)">
            Unfollow
          </button>
        </div>
      </article>
    </div>
    <ng-template #emptyFollowing>
      <p class="empty">You are not following any patterns yet.</p>
    </ng-template>
  </section>

  <section class="pattern-list" id="patterns">
    <header>
      <p class="eyebrow">Community patterns</p>
      <h2>Follow or open any shared pattern.</h2>
      <p *ngIf="error()" class="error">{{ error() }}</p>
    </header>

    <div *ngIf="isLoading()" class="loading">Loading patterns...</div>

    <div *ngIf="!isLoading() && patterns().length === 0" class="empty">No patterns shared yet. Be the first to publish.</div>

    <div class="pattern-grid" *ngIf="patterns().length > 0">
      <article class="pattern-card" *ngFor="let pattern of patterns()">
        <div class="cover" *ngIf="pattern.imageUrl; else placeholder" [style.backgroundImage]="'url(' + pattern.imageUrl + ')'">
          <span class="pill">{{ rowsPreview(pattern) }}</span>
        </div>
        <ng-template #placeholder>
          <div class="cover placeholder">
            <span class="pill">{{ rowsPreview(pattern) }}</span>
          </div>
        </ng-template>

        <div class="card-body">
          <div class="card-title">
            <h3>{{ pattern.title }}</h3>
            <p>{{ pattern.description || 'No description provided.' }}</p>
          </div>

          <div class="meta">
            <span>By {{ pattern.author.handle }}</span>
            <span>Followers: {{ pattern.followerCount }}</span>
          </div>

          <div class="actions">
            <button type="button" (click)="toggleFollow(pattern)" [disabled]="!auth.isLoggedIn()">
              {{ pattern.isFollowing ? 'Unfollow' : 'Follow' }}
            </button>
            <button type="button" (click)="openPattern(pattern)" [class.secondary]="!auth.isLoggedIn()">
              {{ auth.isLoggedIn() ? 'Open' : 'Sign in to view' }}
            </button>
          </div>
        </div>
      </article>
    </div>
  </section>

  <div class="modal-backdrop" *ngIf="showShareModal()" (click)="closeShareModal()">
    <article class="modal" role="dialog" aria-modal="true" aria-labelledby="share-pattern-title" (click)="$event.stopPropagation()">
      <header class="modal__header">
        <div>
          <p class="card-label">Share a pattern</p>
          <h2 id="share-pattern-title">Publish a pattern with rows</h2>
          <p class="muted">Add a cover image, description, and row-by-row instructions.</p>
        </div>
        <button type="button" class="icon-button" (click)="closeShareModal()" aria-label="Close">Ã—</button>
      </header>

      <ng-container *ngIf="auth.isLoggedIn(); else shareModalSignIn">
        <form [formGroup]="shareForm" (ngSubmit)="sharePattern()" novalidate>
          <label>
            <span>Title</span>
            <input formControlName="title" placeholder="e.g., Cozy Moss Stitch Throw" />
          </label>

          <label>
            <span>Description</span>
            <textarea formControlName="description" rows="2" placeholder="Short description"></textarea>
          </label>

          <label>
            <span>Image URL (optional)</span>
            <input formControlName="imageUrl" placeholder="https://..." />
          </label>

          <label>
            <span>Rows (one per line)</span>
            <textarea formControlName="rowsInput" rows="5" placeholder="Row 1: ...&#10;Rows 3-5: repeat step..."></textarea>
          </label>

          <div class="modal__actions">
            <button type="button" class="ghost" (click)="closeShareModal()">Cancel</button>
            <button type="submit" [disabled]="isSubmitting()">{{ isSubmitting() ? 'Saving...' : 'Publish pattern' }}</button>
          </div>
          <p *ngIf="error()" class="error">{{ error() }}</p>
        </form>
      </ng-container>
      <ng-template #shareModalSignIn>
        <article class="share-card share-card--signin">
          <p class="card-label">Sign in to share</p>
          <p class="lede">Create an account to publish patterns with images and rows.</p>
          <a routerLink="/auth" class="cta">Go to sign in</a>
        </article>
      </ng-template>
    </article>
  </div>
</div>
